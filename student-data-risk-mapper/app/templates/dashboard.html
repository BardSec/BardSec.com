{% extends "base.html" %}

{% block title %}Dashboard - Student Data Risk Mapper{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>System Inventory</h1>
        <div class="header-actions">
            {% if user.role.value == 'admin' %}
            <a href="/exports/csv" class="btn btn-secondary">Export CSV</a>
            {% endif %}
            <a href="/systems/new" class="btn btn-primary">+ Add System</a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <span class="card-value">{{ tier_counts.Critical }}</span>
            <span class="card-label tier-critical">Critical Risk</span>
        </div>
        <div class="summary-card">
            <span class="card-value">{{ tier_counts.High }}</span>
            <span class="card-label tier-high">High Risk</span>
        </div>
        <div class="summary-card">
            <span class="card-value">{{ tier_counts.Moderate }}</span>
            <span class="card-label tier-moderate">Moderate Risk</span>
        </div>
        <div class="summary-card">
            <span class="card-value">{{ tier_counts.Low }}</span>
            <span class="card-label tier-low">Low Risk</span>
        </div>
        <div class="summary-card">
            <span class="card-value">{{ tier_counts.Unassessed }}</span>
            <span class="card-label">Unassessed</span>
        </div>
    </div>

    <!-- Filters -->
    <form class="filters-form" method="get" action="/">
        <div class="filter-group">
            <input type="text" name="search" placeholder="Search systems..."
                   value="{{ filter_search }}" class="filter-input">
        </div>
        <div class="filter-group">
            <select name="purpose" class="filter-select">
                <option value="">All Categories</option>
                {% for cat in purpose_categories %}
                <option value="{{ cat.value }}" {% if filter_purpose == cat.value %}selected{% endif %}>
                    {{ cat.value }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <select name="tier" class="filter-select">
                <option value="">All Risk Tiers</option>
                {% for tier in risk_tiers %}
                <option value="{{ tier }}" {% if filter_tier == tier %}selected{% endif %}>
                    {{ tier }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <select name="data_type" class="filter-select">
                <option value="">All Data Types</option>
                {% for key, label in data_types.items() %}
                <option value="{{ key }}" {% if filter_data_type == key %}selected{% endif %}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <select name="sso" class="filter-select">
                <option value="">SSO Status</option>
                <option value="yes" {% if filter_sso == 'yes' %}selected{% endif %}>Has SSO</option>
                <option value="no" {% if filter_sso == 'no' %}selected{% endif %}>No SSO</option>
            </select>
        </div>
        <div class="filter-group">
            <select name="sharing" class="filter-select">
                <option value="">Data Sharing</option>
                <option value="yes" {% if filter_sharing == 'yes' %}selected{% endif %}>Shares Data</option>
                <option value="no" {% if filter_sharing == 'no' %}selected{% endif %}>No Sharing</option>
            </select>
        </div>
        <button type="submit" class="btn btn-filter">Filter</button>
        <a href="/" class="btn btn-link">Clear</a>
    </form>

    <!-- Systems Table -->
    <div class="table-container">
        <table class="systems-table">
            <thead>
                <tr>
                    <th>System Name</th>
                    <th>Vendor</th>
                    <th>Category</th>
                    <th>Risk Score</th>
                    <th>Risk Tier</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for system in systems %}
                <tr>
                    <td>
                        <a href="/systems/{{ system.id }}" class="system-link">
                            {{ system.name }}
                        </a>
                    </td>
                    <td>{{ system.vendor or '-' }}</td>
                    <td>
                        <span class="badge badge-category">{{ system.purpose_category.value }}</span>
                    </td>
                    <td>
                        {% if system.current_assessment %}
                            <span class="score">{{ system.current_assessment.score_total }}</span>
                        {% else %}
                            <span class="score-na">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if system.current_assessment %}
                            {% set tier = system.current_assessment.risk_tier.value %}
                            <span class="badge badge-tier tier-{{ tier|lower }}">{{ tier }}</span>
                        {% else %}
                            <span class="badge badge-tier tier-none">Unassessed</span>
                        {% endif %}
                    </td>
                    <td class="actions">
                        <a href="/systems/{{ system.id }}" class="action-link">View</a>
                        {% if not system.current_assessment %}
                        <a href="/assessments/wizard/{{ system.id }}" class="action-link">Assess</a>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="empty-state">
                        No systems found. <a href="/systems/new">Add your first system</a>.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&search={{ filter_search }}&purpose={{ filter_purpose }}&tier={{ filter_tier }}"
           class="page-link">&laquo; Previous</a>
        {% endif %}

        <span class="page-info">Page {{ page }} of {{ total_pages }} ({{ total }} systems)</span>

        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&search={{ filter_search }}&purpose={{ filter_purpose }}&tier={{ filter_tier }}"
           class="page-link">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
